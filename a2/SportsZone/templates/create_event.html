{% extends "base.html" %}
{% block title %}{{ 'Edit Event' if event else 'Create Event' }} · SportsZone{% endblock %}

{% block body %}

<!--macro to render a field with errors and optional help text -->
{% macro field_row(field, type='text', placeholder='', rows=None, help_text=None, extra_class='') -%}
  {% set invalid = ' is-invalid' if field.errors else '' %}
  <div class="mb-3">
    <label class="form-label">{{ field.label }}</label>
    {% if rows %}
      {{ field(class="form-control" ~ invalid ~ " " ~ extra_class, rows=rows, placeholder=placeholder) }}
    {% elif field.type == 'SelectField' %}
      {{ field(class="form-select" ~ invalid ~ " " ~ extra_class) }}
    {% elif field.type == 'FileField' %}
      {{ field(class="form-control" ~ invalid ~ " " ~ extra_class) }}
    {% else %}
      {{ field(class="form-control" ~ invalid ~ " " ~ extra_class, placeholder=placeholder) }}
    {% endif %}
    {% for err in field.errors %}
      <div class="invalid-feedback d-block">{{ err }}</div>
    {% endfor %}
    {% if help_text %}
      <div class="help-text">{{ help_text }}</div>
    {% endif %}
  </div>
{%- endmacro %}

<div class="create-event-page py-4">
  <div class="content-wrap">
    <div class="page-header text-center mb-3">
      {% if event %}
        <h1>Edit Event</h1>
        <p>Update your event details below.</p>
      {% else %}
        <h1>Create Event</h1>
        <p>Fill out the details to publish your sports event on SportsZone.</p>
      {% endif %}
    </div>

    <!-- Flash messages -->
    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        <div class="mb-3">
          {% for cat, msg in msgs %}
            <div class="alert alert-{{ 'warning' if cat=='message' else cat }} mb-2">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Main create/edit form -->
    <div class="form-section">
      <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        {{ field_row(form.event_title, placeholder="e.g. Real Madrid vs Barcelona") }}
        {{ field_row(form.sport_type) }}

        <div class="row">
          <div class="col-md-6">
            {{ field_row(form.home_team, placeholder="Home team") }}
          </div>
          <div class="col-md-6">
            {{ field_row(form.away_team, placeholder="Away team") }}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            {{ field_row(form.start_datetime) }}
          </div>
          <div class="col-md-6">
            {{ field_row(form.end_datetime) }}
          </div>
        </div>

        {{ field_row(form.venue, placeholder="Venue name or stadium") }}

        <div class="row">
          <div class="col-md-6">
            {{ field_row(form.total_tickets, help_text="Enter total available tickets for this event.") }}
          </div>
          <div class="col-md-6">
            {{ field_row(form.ticket_price, help_text="Standard price per ticket in AUD.") }}
          </div>
        </div>

        <!-- Existing image preview (edit mode only) -->
        {% if event and event.event_image %}
          <div class="mb-3">
            <label class="form-label d-block">Current Image</label>
            <div class="current-image">
              <img src="{{ url_for('static', filename='img/' ~ event.event_image) }}" class="img-fluid" alt="{{ event.event_title }}">
            </div>
            <div class="form-text mt-1">Uploading a new file will replace the current image.</div>
          </div>
        {% endif %}

        {{ field_row(form.image, help_text="Upload a high-quality image (JPG/PNG).") }}
        {{ field_row(form.description, rows=5, placeholder="Write a short description…") }}

        <div class="d-flex flex-wrap gap-2 align-items-center">
          {{ form.submit(class="btn btn-primary", value=('Save Changes' if event else 'Create Event')) }}
          {{ form.reset(class="btn btn-outline-secondary") }}
          <a href="{{ url_for('main.my_events') if event else url_for('main.index') }}" class="btn btn-link">Cancel</a>
        </div>
      </form>

      <!-- Separate cancel-event POST form (kept OUTSIDE main form to avoid nested forms) -->
      {% if event %}
        <form method="POST" action="{{ url_for('main.cancel_event', event_id=event.id) }}"
              class="mt-2"
              onsubmit="return confirm('Cancel this event? This will stop further bookings.');">
          <button class="btn btn-outline-danger" {% if event.status == 'Cancelled' %}disabled{% endif %}>
            Cancel Event
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
